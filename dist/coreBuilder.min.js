/*! coreBuilder 2014-10-07 */
(function(){var root,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};root=this,root.coreBuilder={},function($,coreBuilder,_,Backbone,ace){var Core,CoreEntry,CoreEntryView,FullCoreEntryView,FullCoreView,GroupingView,Selection,SelectionGroup,SelectionGroupView,SelectionView,Source,SourceView,Sources,SourcesView,_ref,_ref1,_ref10,_ref11,_ref12,_ref13,_ref14,_ref15,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;return coreBuilder.Utils={},coreBuilder.Utils.generateUid=function(separator){var S4,delim;return delim=null!=separator?separator:"-",S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},S4()+S4()+delim+S4()+delim+S4()+delim+S4()+delim+S4()+S4()+S4()},coreBuilder.Components={},coreBuilder.Components.FileUploader=function(target){return $(target).change(function(e){var file,reader;return file=e.target.files[0],reader=new FileReader,reader.onload=function(){return function(e){var XMLCore,entries,parser;return parser=new DOMParser,XMLCore=parser.parseFromString(e.target.result,"text/xml"),entries=$(XMLCore).find("app"),entries.each(function(i,e){var entry,string,targets;return string=(new XMLSerializer).serializeToString(e),entry=coreBuilder.Data.Core.add({entry:e,output:string,formatted:string.replace(/</g,"&lt;").replace(/>/g,"&gt;")}),targets={},$(e).find("rdg").each(function(i,r){var ptrs,source,src;return src=$(r).attr("wit").substring(1),source=entry.sources.add({source:src}),targets[src]=[],ptrs=$(r).find("ptr"),ptrs.length>0?ptrs.each(function(i,p){var trgt;return trgt=$(p).attr("target").substring(1),source.selectionGroup.add({xmlid:trgt}),targets[src].push(trgt)}):source.set("empty",!0),entry.set({targets:targets}),entry.trigger("sync")})}),$('#tabs a[href="#full"]').tab("show")}}(file),reader.readAsText(file,"UTF-8")})},coreBuilder.Components.SourceSelector=function(target,data_url){return $(target).multiselect({buttonClass:"btn",buttonWidth:"auto",buttonContainer:'<div class="btn-group" />',maxHeight:250,onChange:function(opt,adding){var escaped_src,s,source,url;return source=$(opt).val(),escaped_src=source.replace(/[\?=\.]/g,"_"),adding?(url=data_url+"/"+source,source=coreBuilder.Data.Sources.add({source:escaped_src,url:url}),$.get(url,function(data){var parser,xmlDoc;return parser=new DOMParser,xmlDoc=parser.parseFromString(data,"text/xml"),source.set({text:data,xmldata:xmlDoc})},"text")):(s=coreBuilder.Data.Sources.get(escaped_src),coreBuilder.Data.Sources.remove(escaped_src),s.trigger("destroy"),s=null)},buttonText:function(options){var label,sel;return sel=[],options.length>0&&options.each(function(){var source_id;return source_id=$(this).text(),sel.push(source_id)}),0===sel.length?'Sources <b class="caret"></b>':(label=sel.join(", "),label.length>50&&(label=label.substring(0,50)+"..."),label+' <b class="caret"></b>')}})},coreBuilder.Components.CoreTabs=function(target){return $(target).click(function(e){return e.preventDefault(),$(this).tab("show")})},coreBuilder.Routers={},coreBuilder.Routers.GoToEditor=function(_super){function GoToEditor(){return _ref=GoToEditor.__super__.constructor.apply(this,arguments)}return __extends(GoToEditor,_super),GoToEditor.prototype.routes={"show/:source":"show","show/:source/:id":"show"},GoToEditor.prototype.show=function(s,i){var ed,fixeds,move,sel,_i,_len,_ref1;if(move=function(){var adjustment,editor,offset,punct;return adjustment=115,editor=ace.edit("ed_"+s),editor.moveCursorTo(1,1),punct="[\"']",editor.find(punct+i+punct,{regExp:!0},!0),offset=$("#ed_"+s).offset().top-adjustment,$("html, body").animate({scrollTop:offset},800)},ed=$("#ed_"+s),null==ed.get(0))for(fixeds=s.replace("_xml",".xml"),fixeds=fixeds.replace("_id_","?id="),_ref1=$(".sel-sources option"),_i=0,_len=_ref1.length;_len>_i;_i++)sel=_ref1[_i],$(sel).val()===fixeds&&($(".sel-sources").multiselect("select",fixeds),setTimeout(move,100));else move();return this.navigate("#")},GoToEditor}(Backbone.Router),coreBuilder.Data={},Source=function(_super){function Source(){return _ref1=Source.__super__.constructor.apply(this,arguments)}return __extends(Source,_super),Source.prototype.idAttribute="source",Source.prototype.defaults={group:void 0},Source.prototype.initialize=function(){return this.selectionGroup=new SelectionGroup},Source}(Backbone.Model),CoreEntry=function(_super){function CoreEntry(){return _ref2=CoreEntry.__super__.constructor.apply(this,arguments)}return __extends(CoreEntry,_super),CoreEntry.prototype.initialize=function(){return this.sources=new Sources},CoreEntry}(Backbone.Model),Selection=function(_super){function Selection(){return _ref3=Selection.__super__.constructor.apply(this,arguments)}return __extends(Selection,_super),Selection.prototype.idAttribute="xmlid",Selection}(Backbone.Model),Sources=function(_super){function Sources(){return _ref4=Sources.__super__.constructor.apply(this,arguments)}return __extends(Sources,_super),Sources.prototype.model=Source,Sources}(Backbone.Collection),SelectionGroup=function(_super){function SelectionGroup(){return _ref5=SelectionGroup.__super__.constructor.apply(this,arguments)}return __extends(SelectionGroup,_super),SelectionGroup.prototype.model=Selection,SelectionGroup}(Backbone.Collection),Core=function(_super){function Core(){return _ref6=Core.__super__.constructor.apply(this,arguments)}return __extends(Core,_super),Core.prototype.model=CoreEntry,Core}(Backbone.Collection),coreBuilder.Data.Sources=new Sources,coreBuilder.Data.Core=new Core,coreBuilder.Views={},SelectionGroupView=function(_super){function SelectionGroupView(){return _ref7=SelectionGroupView.__super__.constructor.apply(this,arguments)}return __extends(SelectionGroupView,_super),SelectionGroupView.prototype.initialize=function(){return this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"remove",this.removeOne)},SelectionGroupView.prototype.addOne=function(m){return this.$el.append(new SelectionView({model:m}).render().el),this},SelectionGroupView.prototype.removeOne=function(m){var id;return null==m.get("empty")&&(id="#sel_"+m.id.replace(/\"/g,""),$(id).remove()),this},SelectionGroupView}(Backbone.View),SelectionView=function(_super){function SelectionView(){return this.render=__bind(this.render,this),this.removeOne=__bind(this.removeOne,this),_ref8=SelectionView.__super__.constructor.apply(this,arguments)}return __extends(SelectionView,_super),SelectionView.prototype.tagName="span",SelectionView.prototype.template=_.template($("#selection-tpl").html()),SelectionView.prototype.events={"click .sel-remove":"removeOne"},SelectionView.prototype.removeOne=function(){return this.model.collection.remove(this.model.id,{silent:!1})},SelectionView.prototype.render=function(){var id;return null==this.model.get("empty")&&(this.$el.addClass("badge"),id="sel_"+this.model.id.replace(/\"/g,""),this.$el.attr("id",id),this.$el.html(this.template(this.model.toJSON()))),this},SelectionView}(Backbone.View),SourceView=function(_super){function SourceView(){return _ref9=SourceView.__super__.constructor.apply(this,arguments)}return __extends(SourceView,_super),SourceView.prototype.template=_.template($("#editor-tpl").html()),SourceView.prototype.initialize=function(){return this.listenToOnce(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},SourceView.prototype.tagName="div",SourceView.prototype.events={"click .add-empty":"addEmpty"},SourceView.prototype.addEmpty=function(e){var _this=this;return this.model.selectionGroup.each(function(s){return _this.model.selectionGroup.remove(s)}),$(e.target).addClass("disabled"),this.model.selectionGroup.add({empty:!0}),this.listenTo(this.model.selectionGroup,"remove",function(m){return null!=m.get("empty")?$(e.target).removeClass("disabled"):void 0})},SourceView.prototype.bindSelect=function(){var _this=this;return $(this.editor.container).click(function(e){var find_q,popup,pos,tagName,token,tokenRow,xmldata,xmlel,xmlid;if(e.stopPropagation(),$("#el_select").remove(),pos=_this.editor.getCursorPosition(),token=_this.editor.session.getTokenAt(pos.row,pos.column),tokenRow=_this.editor.session.getTokens(pos.row),null!=token)switch(!1){case!("entity.other.attribute-name.xml"===token.type&&"xml:id"===token.value):xmlid=tokenRow[token.index+2].value.replace,xmlid=xmlid.replace(/['"]/g,"");break;case!("string.attribute-value.xml"===token.type&&"xml:id"===tokenRow[token.index-2].value):xmlid=token.value,xmlid=xmlid.replace(/["']/g,"")}return null!=xmlid?(xmldata=$(_this.model.get("xmldata")),find_q="*[xml\\:id="+xmlid+"]",xmlel=xmldata.find(find_q),tagName=xmlel.prop("tagName"),popup=$('<button type="button" class="btn btn-default" id="el_select">'+tagName+"</button>"),popup.css({position:"absolute",left:e.pageX,top:e.pageY,"z-index":999}),$("html").append(popup),popup.click(function(e){return e.stopPropagation(),_this.model.selectionGroup.add({ident:tagName,xmlid:xmlid,pos:pos}),popup.remove()})):void 0})},SourceView.prototype.render=function(){return this.$el.html(this.template(this.model.toJSON())),$("#editors").append(this.$el),this.editor=ace.edit("ed_"+this.model.get("source")),this.editor.setReadOnly(!0),this.editor.setTheme("ace/theme/github"),this.editor.getSession().setMode("ace/mode/xml"),this.editor.getSession().insert({column:0,row:0},this.model.get("text")),this.editor.moveCursorTo({column:0,row:0}),this.bindSelect(),this.$el.append(new SelectionGroupView({collection:this.model.selectionGroup}).el),new GroupingView({model:this.model,el:this.$el.find(".groupingView")}).render()},SourceView.prototype.remove=function(){return this.editor.destroy(),$(this.el).empty().remove(),this},SourceView}(Backbone.View),GroupingView=function(_super){function GroupingView(){return _ref10=GroupingView.__super__.constructor.apply(this,arguments)}return __extends(GroupingView,_super),GroupingView.prototype.template=_.template($("#grouping-tpl").html()),GroupingView.prototype.events={"click .add-empty":"addEmpty","click .newGroup":"newGroup","click .removeFromGroup":"removeFromGroup","click ._group":"addToGroup"},GroupingView.prototype.initialize=function(){var _this=this;return this.listenTo(this.model.collection,"change",function(){return _this.render()})},GroupingView.prototype.newGroup=function(e){var groups,latestGroup;return e.preventDefault(),e.stopPropagation(),groups=[],this.model.collection.each(function(sel){var g;return g=sel.get("group"),null!=g?groups.push(g):void 0}),0===groups.length&&(groups=[0]),latestGroup=Math.max.apply(this,groups),this.model.set("group",latestGroup+1),console.log("added to new group",latestGroup+1),this.model.collection.trigger("coll:change")},GroupingView.prototype.removeFromGroup=function(e){return e.preventDefault(),e.stopPropagation(),console.log("removed from group",this.model.get("group")),this.model.set("group",void 0)},GroupingView.prototype.addToGroup=function(e){var g;return e.preventDefault(),e.stopPropagation(),g=$(e.target).data("group"),this.model.set("group",g),console.log("added to group",g)},GroupingView.prototype.render=function(){var adjustedModel,groups;return groups=[],this.model.collection.each(function(sel){var g;return g=sel.get("group"),null!=g&&__indexOf.call(groups,g)<0?groups.push(g):void 0}),adjustedModel=this.model.toJSON(),adjustedModel.groups=groups,adjustedModel.start=null!=this.model.get("group")?!1:!0,adjustedModel.remove=!adjustedModel.start,this.$el.html(this.template(adjustedModel))},GroupingView}(Backbone.View),SourcesView=function(_super){function SourcesView(){return _ref11=SourcesView.__super__.constructor.apply(this,arguments)}return __extends(SourcesView,_super),SourcesView.prototype.initialize=function(){return this.listenTo(this.collection,"add",this.addOne)},SourcesView.prototype.addOne=function(model){return new SourceView({model:model})},SourcesView}(Backbone.View),CoreEntryView=function(_super){function CoreEntryView(){return _ref12=CoreEntryView.__super__.constructor.apply(this,arguments)}return __extends(CoreEntryView,_super),CoreEntryView.prototype.el="#cur_entry",CoreEntryView.prototype.template=_.template($("#core-tpl").html()),CoreEntryView.prototype.events={"click #entry_add":"addEntry","click #entry_cancel":"remove"},CoreEntryView.prototype.addEntry=function(){var entry,msg,r,sg,source,targets,_i,_j,_k,_len,_len1,_len2,_ref13,_ref14,_ref15;for(targets={},_ref13=this.collection.models,_i=0,_len=_ref13.length;_len>_i;_i++)for(r=_ref13[_i],source=r.get("source"),targets[source]=[],_ref14=r.selectionGroup.models,_j=0,_len1=_ref14.length;_len1>_j;_j++)sg=_ref14[_j],targets[source].push(sg.get("xmlid"));for(entry=coreBuilder.Data.Core.add({entry:this.toDOM(),formatted:this.toXMLString(!0),output:this.toXMLString(!1),targets:targets}),_ref15=this.collection.models,_k=0,_len2=_ref15.length;_len2>_k;_k++)r=_ref15[_k],r.set("group",void 0);return entry.sources=this.collection,entry.trigger("sync"),this.remove(),msg=$('<div class="alert alert-success fade in">Added!</div>'),this.$el.html(msg),$(msg).alert(),window.setTimeout(function(){return $(msg).alert("close")},500)},CoreEntryView.prototype.toDOM=function(){var entry,g,grp,grpNum,grps,k,p,ptr,r,sel,_i,_j,_k,_len,_len1,_len2,_ref13,_ref14,_ref15,_ref16,_ref17;for(grps={},entry=$("<app>"),_ref13=this.collection.models,_i=0,_len=_ref13.length;_len>_i;_i++)if(r=_ref13[_i],(null!=(_ref14=r.selectionGroup)?_ref14.length:void 0)>0){sel=$("<rdg>").attr({wit:"#"+r.get("source")}),r.get("group")?(grpNum=r.get("group"),grpNum in grps?grps[grpNum].push(sel):grps[grpNum]=[sel]):entry.append(sel),_ref15=r.selectionGroup.models;for(_j=0,_len1=_ref15.length;_len1>_j;_j++)p=_ref15[_j],(null!=(_ref16=p.get("xmlid"))?_ref16.length:void 0)>0&&(ptr=$("<ptr>").attr({target:"#"+p.get("xmlid")}),sel.append(ptr))}for(k in grps)for(grp=$("<rdgGrp>"),grp.attr("n",k),_ref17=grps[k],_k=0,_len2=_ref17.length;_len2>_k;_k++)g=_ref17[_k],entry.append(grp),grp.append(g);return entry},CoreEntryView.prototype.toXMLString=function(escape){var xml_string;return xml_string=vkbeautify.xml(this.toDOM().wrap("<s>").parent().html()),escape&&(xml_string=xml_string.replace(/</g,"&lt;"),xml_string=xml_string.replace(/>/g,"&gt;")),xml_string},CoreEntryView.prototype.initialize=function(){return this.listenTo(this.collection,"add",this.addOne),this},CoreEntryView.prototype.addOne=function(model){return this.listenTo(model.selectionGroup,"add",this.render),this.listenTo(model.selectionGroup,"remove",this.render),this.listenTo(model,"change",this.render),this},CoreEntryView.prototype.render=function(){var att,attrs,check_id,id,r,sg,source,sources,target,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref13,_ref14,_ref15,_ref16;for(this.$el.empty(),sources=[],_ref13=this.collection.models,_i=0,_len=_ref13.length;_len>_i;_i++)r=_ref13[_i],(null!=(_ref14=r.selectionGroup)?_ref14.length:void 0)>0&&sources.push(r.get("source"));if(sources.length>0)for(this.$el.html(this.template({xml_string:this.toXMLString(!0),sources:sources})),Prism.highlightElement(this.$el.find("code")[0]),_ref15=this.collection.models,_j=0,_len1=_ref15.length;_len1>_j;_j++)for(r=_ref15[_j],source=r.get("source"),_ref16=r.selectionGroup.models,_k=0,_len2=_ref16.length;_len2>_k;_k++)for(sg=_ref16[_k],id=sg.get("xmlid"),check_id="#"!==(null!=id?id.slice(0,1):void 0)?"#"+id:id,attrs=this.$el.find(".token.attr-name"),_l=0,_len3=attrs.length;_len3>_l;_l++)att=attrs[_l],"target"===$(att).text()&&(target=$(att).next().contents().filter(function(){return 1!==this.nodeType}),target.text()===check_id&&("#"===source.slice(0,1)&&(source=source.slice(1)),"#"===id.slice(0,1)&&(id=id.slice(1)),target.wrap("<a href='#show/"+source+"/"+id+"''></a>")));return this},CoreEntryView.prototype.remove=function(){return console.log(this.collection),this.collection.each(function(c){return c.set("group",void 0),c.selectionGroup.each(function(s){return c.selectionGroup.remove(s)})}),this.$el.empty(),this},CoreEntryView}(Backbone.View),FullCoreView=function(_super){function FullCoreView(){return _ref13=FullCoreView.__super__.constructor.apply(this,arguments)}return __extends(FullCoreView,_super),FullCoreView.prototype.initialize=function(){return this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this},FullCoreView.prototype.render=function(){var _this=this;return this.$el.empty(),this.collection.each(function(entry){return _this.$el.append(new FullCoreEntryView({model:entry}).delegateEvents().render().el)}),this},FullCoreView}(Backbone.View),FullCoreEntryView=function(_super){function FullCoreEntryView(){return _ref14=FullCoreEntryView.__super__.constructor.apply(this,arguments)}return __extends(FullCoreEntryView,_super),FullCoreEntryView.prototype.template=_.template($("#entry-tpl").html()),FullCoreEntryView.prototype.tagName="pre",FullCoreEntryView.prototype.events={"click .close":"remove"},FullCoreEntryView.prototype.render=function(){var linkTargets,xml_string,_this=this;return xml_string=this.model.get("formatted"),xml_string=xml_string.replace(/</g,"&lt;"),xml_string=xml_string.replace(/>/g,"&gt;"),this.$el.html(this.template({escaped_xml:xml_string})),linkTargets=function(){var att,attrs,check_id,id,source,target,targets,_results;Prism.highlightElement(_this.$el.find("code")[0]),targets=_this.model.get("targets"),_results=[];for(source in targets)_results.push(function(){var _i,_len,_ref15,_results1;for(_ref15=targets[source],_results1=[],_i=0,_len=_ref15.length;_len>_i;_i++)id=_ref15[_i],check_id="#"!==(null!=id?id.slice(0,1):void 0)?"#"+id:id,attrs=this.$el.find(".token.attr-name"),_results1.push(function(){var _j,_len1,_results2;for(_results2=[],_j=0,_len1=attrs.length;_len1>_j;_j++)att=attrs[_j],"target"===$(att).text()?(target=$(att).next().contents().filter(function(){return 1!==this.nodeType}),target.text()===check_id?("#"===source.slice(0,1)&&(source=source.slice(1)),"#"===id.slice(0,1)&&(id=id.slice(1)),_results2.push(target.wrap("<a href='#show/"+source+"/"+id+"''></a>"))):_results2.push(void 0)):_results2.push(void 0);return _results2}());return _results1}.call(_this));return _results},this.model.sources.length>0?linkTargets():this.listenToOnce(this.model,"sync",function(){return linkTargets()}),this},FullCoreEntryView.prototype.remove=function(){return this.model.collection.remove(this.model),this},FullCoreEntryView}(Backbone.View),coreBuilder.App=function(_super){function App(){return _ref15=App.__super__.constructor.apply(this,arguments)}return __extends(App,_super),App.prototype.el="#coreBuilder",App.prototype.events={"click #downloadCore":"download"},App.prototype.initialize=function(options){var fcv,h;return Backbone.history.start(),new coreBuilder.Routers.GoToEditor,coreBuilder.Components.SourceSelector(".sel-sources",options.data_url),coreBuilder.Components.FileUploader("#uploadCore"),coreBuilder.Components.CoreTabs("#tabs"),new SourcesView({collection:coreBuilder.Data.Sources}),new CoreEntryView({collection:coreBuilder.Data.Sources}),fcv=new FullCoreView({collection:coreBuilder.Data.Core}),$("#full").html(fcv.$el),h=$(window).height()-120,$("#corexml").css("height",h+"px"),this.render()},App.prototype.download=function(){var bb,xml;return xml="<core>",coreBuilder.Data.Core.each(function(e){return xml+=e.get("output")}),xml+="</core>",bb=new Blob([xml],{type:"text/xml"}),saveAs(bb,"core.xml")},App.prototype.render=function(){return $("#uploadCore").popover({content:"Pick a source to start selecting elements, or upload an existing Core file.",title:"Getting Started",placement:"bottom",trigger:"manual",container:"#sources"}),$("#uploadCore").popover("show"),$("body").one("click",function(){return $("#uploadCore").popover("hide")})},App}(Backbone.View)}(jQuery,coreBuilder,_,Backbone,ace)}).call(this);